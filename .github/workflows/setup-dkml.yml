# setup-dkml. Short form: sd4
name: setup-dkml

env:
  # Maintained by https://github.com/diskuv/diskuv-communicator-android/blob/main/vendor/diskuv-communicator-kernel/vendor/diskuv-ocaml/contributors/release.sh
  # in the main branch.
  DEFAULT_DISKUV_OPAM_REPOSITORY_TAG: 36bb91955f0dc5b5710239834f6fcda1db43c221

  DEFAULT_OCAML_VERSION: "4.12.1"
  PIN_BASE: "v0.14.3"
  PIN_BIGSTRINGAF: "0.8.0"
  PIN_CORE_KERNEL: "v0.14.2"
  PIN_CTYPES_FOREIGN: "0.19.2-windowssupport-r4"
  PIN_CTYPES: "0.19.2-windowssupport-r4"
  PIN_CURLY: "0.2.1-windows-env_r2"
  PIN_DIGESTIF: "1.0.1"
  PIN_DUNE: "2.9.3"
  PIN_OCAMLBUILD: "0.14.0"
  PIN_OCAMLFIND: "1.9.1"
  PIN_OCP_INDENT: "1.8.2-windowssupport"
  PIN_PPX_EXPECT: "v0.14.1"
  PIN_PTIME: "0.8.6-msvcsupport"
  PIN_TIME_NOW: "v0.14.0"

  # Can't be 1.0.0 or later until https://github.com/ocaml/opam-repository/pull/21704 ocaml-option-32bit
  # can come back in.
  DKML_VERSION: "0.4.0"

on:
  workflow_call:
    outputs:
      import_func:
        description: |
          A shell script that can be eval'd or executed inline in a POSIX shell, that defines
          a shell function 'import'. When 'import HOST_TARGET_ABIS' is called a `opamrun`
          command will be available to subsequent GitHub Action steps.
        value: |
          import() {
            import_HOST_TARGET_ABIS=$1
            shift

            case "$import_HOST_TARGET_ABIS" in
              win32*)         import_OPAMROOT="D:/.opam" ;;
              macos*)         import_OPAMROOT="/Users/runner/.opam" ;;
              manylinux2014*) import_OPAMROOT=".ci/opamroot" ;;
              *)
                printf "FATAL: Unsupported abi: %s\n" "$import_HOST_TARGET_ABIS" >&2
                exit 109
                ;;
            esac

            ls -R .ci/dist/setup-dkml-${import_HOST_TARGET_ABIS} >&2

            install -d "$import_OPAMROOT"
            tar xCfz "$import_OPAMROOT" .ci/dist/setup-dkml-${import_HOST_TARGET_ABIS}/opamroot.tar.gz

            install -d .ci/sd4/g
            tar xCfz .ci/sd4/g .ci/dist/setup-dkml-${import_HOST_TARGET_ABIS}/sources.tar.gz

            # Extract Opam executable and scripts
            tar xvf .ci/dist/setup-dkml-${import_HOST_TARGET_ABIS}/env-opam.tar

            # Expose opamrun to remaining GitHub Action steps
            opamrunabs="$GITHUB_WORKSPACE/.ci/sd4/opamrun"
            if [ -x /usr/bin/cygpath ]; then opamrunabs=$(/usr/bin/cygpath -aw "$opamrunabs"); fi
            echo "$opamrunabs" >> $GITHUB_PATH
            #   Special case: GITHUB_PATH does not influence msys2.CMD of msys2/setup-msys2@v2, so place in real MSYS2 PATH
            if [ -n "${MSYSTEM:-}" ]; then
              install -d /usr/local/bin
              install -v .ci/sd4/opamrun/opamrun /usr/local/bin/opamrun
              # Also get rid of link.exe; it interferes with MSVC's link.exe
              mv -v /usr/bin/link.exe /usr/bin/link.gnu.exe
            fi
          }

    # WARNING: The inputs.*.default seem to do nothing!
    inputs:
      fdopen-opamexe-bootstrap:
        type: boolean
        description: "Use opam.exe from fdopen on Windows. Typically only used when bootstrapping Opam for the first time. May be needed to solve '\"create_process\" failed on sleep: Bad file descriptor' which may need https://github.com/ocaml/opam/commit/417b97d8cfada35682a0f4107eb2e4f9e24fba91"
        required: false
        default: false
      cache-prefix:
        type: string
        description: The prefix of the cache keys.
        required: false
        default: "v2"
      ocaml-compiler:
        type: string
        description: "The version of the OCaml compiler, as tagged by the https://github.com/diskuv/dkml-base-compiler repository. If not specified the latest compiler, or the version associated with the 'dkml-compiler' input, is used. Currently only 4.12.1 is supported"
        required: false
      dkml-compiler:
        type: string
        description: "Git branch, tag or commit for dkml-compiler. However if ocaml-compiler is specified the 'dkml-base-compiler' version is taken from ocaml-compiler."
        required: false
        default: "" # "@repository@" = Opam ; "" = latest from default branch of git clone
      conf-dkml-cross-toolchain:
        type: string
        description: "Git branch, tag or commit for conf-dkml-cross-toolchain"
        required: false
        default: "@repository@" # "@repository@" = Opam ; "" = latest from default branch of git clone
      diskuv-opam-repository:
        type: string
        description: "Git branch, tag or commit for diskuv-opam-repository"
        required: false
        default: "" # DEFAULT_DISKUV_OPAM_REPOSITORY_TAG is used as default for empty strings
      verbose:
        type: boolean
        required: false
        default: false

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        # bootstrap-opam-version
        #   We need an old working Opam; see BOOTSTRAPPING.md of dkml-installer repository.
        #   We use https://github.com/diskuv/dkml-installer-ocaml/releases
        #   to get an old one; you specify its version number here.
        #   Special value of 'os' means use the OS's package manager
        #   (yum/apt/brew).
        # opam-root
        #   OPAMROOT must be a subdirectory of GITHUB_WORKSPACE if running in
        #   dockcross so that the Opam root (and switch) is visible in both the
        #   parent and Docker context. Always specify this form as a relative
        #   path under GITHUB_WORKSPACE.
        #   When not using dockcross, it should be an absolute path to a
        #   directory with a short length to minimize the 260 character
        #   limit on Windows (macOS/XCode also has some small limit).
        #   CAUTION: The opam-root MUST be in sync with outputs.import_func!
        # vsstudio-hostarch
        #   Only needed if `os: windows-*`. The ARCH in
        #   `vsdevcmd.bat -host_arch=ARCH`. Example: x64.
        #   If you have a 64-bit Intel machine you should not use x86 because
        #   _WIN64 will be defined (see https://docs.microsoft.com/en-us/cpp/preprocessor/predefined-macros?view=msvc-170)
        #   which is based on the host machine architecture (unless you explicitly
        #   cross-compile with different ARCHs; that is, -host_arch=x64 -arch=x75).
        #   Confer: https://docs.microsoft.com/en-us/cpp/build/building-on-the-command-line?view=msvc-170#use-the-developer-tools-in-an-existing-command-window
        #   If you see ppx problems with missing _BitScanForward64 then
        #   https://github.com/janestreet/base/blob/8993e35ba2e83e5020b2deb548253ef1e4a699d4/src/int_math_stubs.c#L25-L32
        #   has been compiled with the wrong host architecture.
        # vsstudio-arch
        #   Only needed if `os: windows-*`. The ARCH in
        #   `vsdevcmd.bat -arch=ARCH`. Example: x86.
        #   Confer: https://docs.microsoft.com/en-us/cpp/build/building-on-the-command-line?view=msvc-170#use-the-developer-tools-in-an-existing-command-window
        # vsstudio-<others>
        #   Hardcodes details about Visual Studio rather than let DKML discover
        #   a compatible Visual Studio installation.
        #   Example:
        #     vsstudio-dir: 'C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise'
        #     vsstudio-vcvarsver: '14.16'
        #     vsstudio-winsdkver: '10.0.18362.0'
        #     vsstudio-msvspreference: 'VS16.5'
        #     vsstudio-cmakegenerator: 'Visual Studio 16 2019'

        # ocaml-options:
        #   Space separated list of `ocaml-option-*` packages.
        #
        #   Use 32-bit installers when possible for maximum portability of
        #   OCaml bytecode. Linux has difficulty with 32-bit (needs gcc-multilib, etc.)
        #   macos is only the major platform without 32-bit.
        #   You don't need to include `ocaml-option-32bit` because it is auto
        #   chosen when the target ABI ends with x86.

        include:
          # ------------
          # windows-2019
          #   https://github.com/actions/virtual-environments/blob/main/images/win/Windows2019-Readme.md
          # ------------

          - os: windows-2019 # 2019 has Visual Studio 2019
            abi-pattern: win32-windows_x86
            default_shell: msys2 {0}
            msys2_system: MINGW32
            msys2_packages: mingw-w64-i686-pkg-config
            exe_ext: .exe
            bootstrap-opam-version: "2.2.0-alpha-20221104"
            opam-abi: windows_x86
            dkml-host-abi: windows_x86
            opam-root: D:/.opam
            vsstudio-hostarch: x64
            vsstudio-arch: x86
            ocaml-options: ocaml-option-32bit
          - os: windows-2019 # 2019 has Visual Studio 2019
            abi-pattern: win32-windows_x86_64
            default_shell: msys2 {0}
            msys2_system: CLANG64
            msys2_packages: mingw-w64-clang-x86_64-pkg-config
            exe_ext: .exe
            bootstrap-opam-version: "2.2.0-alpha-20221104"
            opam-abi: windows_x86_64
            dkml-host-abi: windows_x86_64
            opam-root: D:/.opam
            vsstudio-hostarch: x64
            vsstudio-arch: x64
          # Unnecessary to use VS 14.16, but it serves as a good template for
          # other (future) VS versions.
          # - os: windows-2019 # 2019 has Visual Studio 2019
          #   abi-pattern: win32_1416-windows_64 # VS2017 compiler available to VS2019
          #   default_shell: msys2 {0}
          #   msys2_system: CLANG64
          #   msys2_packages: mingw-w64-clang-x86_64-pkg-config
          #   exe_ext: .exe
          #   bootstrap-opam-version: "2.2.0-alpha-20221104"
          #   opam-abi: windows_x86_64
          #   dkml-host-abi: windows_x86_64
          #   opam-root: D:/.opam
          #   vsstudio-hostarch: x64
          #   vsstudio-arch: x64
          #   vsstudio-dir: 'C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise'
          #   vsstudio-vcvarsver: '14.16'
          #   vsstudio-winsdkver: '10.0.18362.0'
          #   vsstudio-msvspreference: 'VS16.5'
          #   vsstudio-cmakegenerator: 'Visual Studio 16 2019'

          # ------------
          # windows-2022
          #   https://github.com/actions/virtual-environments/blob/main/images/win/Windows2022-Readme.md
          # ------------

          # Disabled because haven't done opam log dumps on failure for
          # `opam upgrade`. See https://github.com/diskuv/dkml-component-ocamlcompiler/runs/6059642542?check_suite_focus=true
          # - os: windows-2022
          #   abi-pattern: win32_2022-windows_x86_64
          #   default_shell: msys2 {0}
          #   msys2_system: CLANG64
          #   msys2_packages: mingw-w64-clang-x86_64-pkg-config
          #   exe_ext: .exe
          #   bootstrap-opam-version: "2.2.0-alpha-20221104"
          #   opam-abi: windows_x86_64
          #   dkml-host-abi: windows_x86_64
          #   opam-root: D:/.opam
          #   vsstudio-hostarch: x64
          #   vsstudio-arch: x64
          #   vsstudio-dir: 'C:\Program Files\Microsoft Visual Studio\2022\Enterprise'
          #   vsstudio-vcvarsver: '14.29'
          #   vsstudio-winsdkver: '10.0.20348.0'
          #   vsstudio-msvspreference: 'VS16.11'
          #   vsstudio-cmakegenerator: 'Visual Studio 17 2022'

          - os: macos-latest
            abi-pattern: macos-darwin_all
            default_shell: sh
            bootstrap-opam-version: "2.2.0-alpha-20221104"
            dkml-host-abi: darwin_x86_64
            opam-root: /Users/runner/.opam

          # --- NOT APPLICABLE: BUG FIXED ---
          # OCaml 4.12.1 can't compile on manylinux2014 x86 (32-bit). It gives:
          #
          #     /opt/rh/devtoolset-10/root/usr/bin/gcc -c -O2 -fno-strict-aliasing -fwrapv -Wall -Wdeclaration-after-statement -fno-common -fexcess-precision=standard -fno-tree-vrp -ffunction-sections -g -Wno-format -D_FILE_OFFSET_BITS=64 -D_REENTRANT -DCAML_NAME_SPACE   -DCAMLDLLIMPORT= -DNATIVE_CODE -DTARGET_amd64 -DMODEL_default -DSYS_linux   -o signals_nat.n.o signals_nat.c
          #     In file included from signals_nat.c:35:
          #     signals_nat.c: In function ‘segv_handler’:
          #     signals_osdep.h:34:72: error: ‘REG_CR2’ undeclared (first use in this function); did you mean ‘REG_CS’?
          #       34 |   #define CONTEXT_FAULTING_ADDRESS ((char *)context->uc_mcontext.gregs[REG_CR2])
          #           |                                                                        ^~~~~~~
          #     signals_nat.c:207:16: note: in expansion of macro ‘CONTEXT_FAULTING_ADDRESS’
          #       207 |   fault_addr = CONTEXT_FAULTING_ADDRESS;
          #           |                ^~~~~~~~~~~~~~~~~~~~~~~~
          #     signals_osdep.h:34:72: note: each undeclared identifier is reported only once for each function it appears in
          #       34 |   #define CONTEXT_FAULTING_ADDRESS ((char *)context->uc_mcontext.gregs[REG_CR2])
          #           |                                                                        ^~~~~~~
          #     signals_nat.c:207:16: note: in expansion of macro ‘CONTEXT_FAULTING_ADDRESS’
          #       207 |   fault_addr = CONTEXT_FAULTING_ADDRESS;
          #           |                ^~~~~~~~~~~~~~~~~~~~~~~~
          #     signals_osdep.h:32:50: error: ‘REG_RSP’ undeclared (first use in this function); did you mean ‘REG_ESP’?
          #       32 |   #define CONTEXT_SP (context->uc_mcontext.gregs[REG_RSP])
          #           |                                                  ^~~~~~~
          #     signals_nat.c:210:33: note: in expansion of macro ‘CONTEXT_SP’
          #       210 |       && (uintnat)fault_addr >= CONTEXT_SP - EXTRA_STACK
          #           |                                 ^~~~~~~~~~
          #     signals_osdep.h:31:50: error: ‘REG_RIP’ undeclared (first use in this function); did you mean ‘REG_EIP’?
          #       31 |   #define CONTEXT_PC (context->uc_mcontext.gregs[REG_RIP])
          #           |                                                  ^~~~~~~
          #     signals_nat.c:212:49: note: in expansion of macro ‘CONTEXT_PC’
          #       212 |       && caml_find_code_fragment_by_pc((char *) CONTEXT_PC) != NULL
          #           |                                                 ^~~~~~~~~~
          #     make[1]: *** [signals_nat.n.o] Error 1
          #     make[1]: Leaving directory `/work/opamroot/dkml/src-ocaml/runtime'
          #     make: *** [makeruntimeopt] Error 2
          #     FATAL: make opt-core failed
          - os: ubuntu-latest
            abi-pattern: manylinux2014-linux_x86
            comment: (CentOS 7, etc.)
            default_shell: sh
            bootstrap-opam-version: "2.2.0-alpha-20221104"
            dkml-host-abi: linux_x86
            opam-root: .ci/opamroot # local directory of $GITHUB_WORKSPACE so available to dockcross
            in_docker: "true"
            dockcross_image: dockcross/manylinux2014-x86
            #   Gets rid of: WARNING: The requested image's platform (linux/386) does not match the detected host platform (linux/amd64) and no specific platform was requested
            dockcross_run_extra_args: --platform linux/386

          # - os: ubuntu-latest
          #   abi-pattern: manylinux_2_24-linux_x86
          #   comment: (glibc>=2.24, Debian 9, etc.)
          #   default_shell: sh
          #   bootstrap-opam-version: "2.2.0-alpha-20221104"
          #   dkml-host-abi: linux_x86
          #   opam-root: .ci/opamroot # local directory of $GITHUB_WORKSPACE so available to dockcross
          #   docker_runner: docker run --platform linux/386 --rm -v $GITHUB_WORKSPACE:/work --workdir=/work quay.io/pypa/manylinux_2_24_i686 linux32
          #   in_docker: "true"

          - os: ubuntu-latest
            abi-pattern: manylinux2014-linux_x86_64
            comment: (CentOS 7, etc.)
            default_shell: sh
            bootstrap-opam-version: "2.2.0-alpha-20221104"
            dkml-host-abi: linux_x86_64
            opam-root: .ci/opamroot # local directory of $GITHUB_WORKSPACE so available to dockcross
            dockcross_image: dockcross/manylinux2014-x64
            in_docker: "true"

    runs-on: ${{ matrix.os }}
    name: ${{ matrix.abi-pattern }} ${{ matrix.comment }}

    defaults:
      run:
        shell: ${{ matrix.default_shell }}

    env:
      OPAMROOT: ${{ matrix.opam-root }}
      EXE_EXT: ${{ matrix.exe_ext }}

      # When non-empty, instead of building the standard components from the
      # central Opam repository, use the github/gitlab development repositories
      # directly.
      CONF_DKML_CROSS_TOOLCHAIN:        "${{ inputs.conf-dkml-cross-toolchain }}"
      DISKUV_OPAM_REPOSITORY:           "${{ inputs.diskuv-opam-repository }}"

      # These are not independent of dkml-compiler; they reside in same
      # repository; we cannot go over max 10 GitHub workflow inputs.
      DKML_OPTION_32BIT:                "${{ inputs.dkml-compiler }}"
      DKML_BASE_COMPILER:               "${{ inputs.dkml-compiler }}"

      SHA512_DEVNULL: "cf83e1357eefb8bdf1542850d66d8007d620e4050b5715dc83f4a921d36ce9ce47d0d13c5d85f2b0ff8318d2877eec2f63b931bd47417a81a538327af927da3e"
    steps:
      # Install utilities
      #   wget: Needed for the Windows Opam download-command
      #   make: Needed for OCaml ./configure + make
      #   pkg-config: conf-pkg-config is used by many OCaml packages like digestif.
      #   rsync: On Windows the `cp` fallback can fail; loosely related to
      #        https://github.com/ocaml/opam/issues/4080
      #   diffutils: Needed for diff, which is needed for Opam
      #   patch: Needed for Opam
      #   unzip: Needed for Opam
      #   git: Needed for Opam
      #   tar: For Opam 2.0 from fdopen, we need MSYS2/Cygwin tar that can handle
      #      Unix paths like /tmp.
      #   xz is not for OCaml; just to get opam64.tar.xz from fdopen
      - name: Install MSYS2 (Windows)
        if: startsWith(matrix.dkml-host-abi, 'windows')
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.msys2_system }}
          update: true
          install: >-
            ${{ matrix.msys2_packages }}
            wget
            make
            rsync
            diffutils
            patch
            unzip
            git
            tar
            xz

      - name: Uninstall MSYS2 conflicting executables (Windows)
        if: startsWith(matrix.dkml-host-abi, 'windows')
        # link.exe interferes with MSVC's link.exe
        run: rm -vf /usr/bin/link.exe

      - name: Prepare cache keys
        # An undocumented bug with GitHub Actions is that a space in the key
        # will "succeed" but it never gets restored. So we will hash a
        # user-friendly file instead.
        run: |
          cachebust=2
          {
            echo $cachebust
            echo 'env.DEFAULT_DISKUV_OPAM_REPOSITORY_TAG=${{ env.DEFAULT_DISKUV_OPAM_REPOSITORY_TAG }}'
            echo 'inputs.fdopen-opamexe-bootstrap=${{ inputs.fdopen-opamexe-bootstrap }}'
            echo 'matrix.dkml-host-abi=${{ matrix.dkml-host-abi }}'
            echo 'matrix.opam-abi=${{ matrix.opam-abi }}'
            echo 'matrix.bootstrap-opam-version=${{ matrix.bootstrap-opam-version }}'
          } | tee cachekey.opam.binaries

          {
            echo $cachebust
            echo 'matrix.vsstudio-arch=${{ matrix.vsstudio-arch }}'
            echo 'matrix.vsstudio-hostarch=${{ matrix.vsstudio-hostarch }}'
            echo 'matrix.vsstudio-dir=${{ matrix.vsstudio-dir }}'
            echo 'matrix.vsstudio-vcvarsver=${{ matrix.vsstudio-vcvarsver }}'
            echo 'matrix.vsstudio-winsdkver=${{ matrix.vsstudio-winsdkver }}'
            echo 'matrix.vsstudio-msvspreference=${{ matrix.vsstudio-msvspreference }}'
            echo 'matrix.vsstudio-cmakegenerator=${{ matrix.vsstudio-cmakegenerator }}'
          } | tee cachekey.vsstudio

          {
            echo $cachebust
            echo 'inputs.ocaml-compiler=${{ inputs.ocaml-compiler }}'
            echo 'inputs.diskuv-opam-repository=${{ inputs.diskuv-opam-repository }}'
            echo 'inputs.dkml-compiler=${{ inputs.dkml-compiler }}'
            echo 'inputs.conf-dkml-cross-toolchain=${{ inputs.conf-dkml-cross-toolchain }}'
            echo 'env.DKML_VERSION=${{ env.DKML_VERSION }}'
          } | tee cachekey.github.inputs

      # Bootstrapping Opam

      - name: Cache Opam bootstrap by OS
        uses: actions/cache@v3
        id: cache-sd4-bs
        with:
          path: .ci/sd4/bs
          key:
            ${{ inputs.cache-prefix }}_${{ runner.os }}-sd4-bs-${{ hashFiles('cachekey.opam.binaries') }}

      #   Bootstrap from historical release
      - name: Bootstrap Opam from fdopen (Windows)
        if: steps.cache-sd4-bs.outputs.cache-hit != 'true' && inputs.fdopen-opamexe-bootstrap && startsWith(matrix.dkml-host-abi, 'windows')
        run: |
          #!/bin/sh
          set -eufx

          install -d .ci/sd4/bs/bin
          wget -O "$GITHUB_WORKSPACE"/.ci/sd4/opam64.tar.xz https://github.com/fdopen/opam-repository-mingw/releases/download/0.0.0.2/opam64.tar.xz

          # this stalls: tar xvCfJ "$GITHUB_WORKSPACE"/.ci/sd4 "$GITHUB_WORKSPACE"/.ci/sd4/opam64.tar.xz
          xz -v -d "$GITHUB_WORKSPACE"/.ci/sd4/opam64.tar.xz
          tar xvCf .ci/sd4 .ci/sd4/opam64.tar

          mv -v "$GITHUB_WORKSPACE"/.ci/sd4/opam64/bin/opam.exe            "$GITHUB_WORKSPACE"/.ci/sd4/bs/bin/
          mv -v "$GITHUB_WORKSPACE"/.ci/sd4/opam64/bin/opam-installer.exe  "$GITHUB_WORKSPACE"/.ci/sd4/bs/bin/
          rm -rf "$GITHUB_WORKSPACE"/.ci/sd4/bs/bin/Opam.Runtime.amd64
          mv -v "$GITHUB_WORKSPACE"/.ci/sd4/opam64/bin/Opam.Runtime.amd64/ "$GITHUB_WORKSPACE"/.ci/sd4/bs/bin/
          ldd "$GITHUB_WORKSPACE"/.ci/sd4/bs/bin/opam.exe
          ldd "$GITHUB_WORKSPACE"/.ci/sd4/bs/bin/opam-installer.exe
      - name: Bootstrap Opam from historical release (non-Windows; Windows non-fdopen)
        if: "steps.cache-sd4-bs.outputs.cache-hit != 'true' && !(inputs.fdopen-opamexe-bootstrap && startsWith(matrix.dkml-host-abi, 'windows')) && matrix.bootstrap-opam-version != 'os'"
        env:
          VER: ${{ matrix.bootstrap-opam-version }}
        run: |
          #!/bin/sh
          set -eufx
          install -d .ci/sd4/bs
          cd .ci/sd4/bs

          if [ ! -e version ] || [ "$(cat version)" != "$VER" ]; then
            curl -L -o opam.tar.gz "https://github.com/diskuv/dkml-component-opam/releases/download/v${{ matrix.bootstrap-opam-version }}/dkml-component-staging-opam.tar.gz"
            tar tvfz opam.tar.gz
            tar xfz opam.tar.gz "./staging-files/${{ matrix.dkml-host-abi}}/"
            rm -rf bin/
            mv "staging-files/${{ matrix.dkml-host-abi}}/bin" .
            rm -rf "${{ matrix.abi-pattern }}"
            printf "%s" "${{ matrix.bootstrap-opam-version }}" > version
          fi
          rm -f opam.tar.gz

      #   Bootstrap from package manager or GitHub ocaml/opam release
      - name: Bootstrap Opam from package manager (macOS)
        if: startsWith(matrix.dkml-host-abi, 'darwin') && matrix.bootstrap-opam-version == 'os'
        run: brew install gpatch && brew install opam
      - name: Bootstrap Opam from GitHub ocaml/opam release (Linux x86_64)
        if: steps.cache-sd4-bs.outputs.cache-hit != 'true' && matrix.dkml-host-abi == 'linux_x86_64' && matrix.bootstrap-opam-version == 'os'
        run: |
          #!/bin/sh
          set -eufx
          install -d .ci/sd4/bs/bin
          if [ ! -x .ci/sd4/bs/bin/opam ]; then
            wget -O .ci/sd4/bs/bin/opam.tmp https://github.com/ocaml/opam/releases/download/2.1.2/opam-2.1.2-x86_64-linux
            sha512_check=$(openssl sha512 2>&1 < /dev/null | cut -f 2 -d ' ')
            if [ "x$SHA512_DEVNULL" = "x$sha512_check" ]; then
                sha512=$(openssl sha512 ".ci/sd4/bs/bin/opam.tmp" 2> /dev/null | cut -f 2 -d ' ')
                check="c0657ecbd4dc212587a4da70c5ff0402df95d148867be0e1eb1be8863a2851015f191437c3c99b7c2b153fcaa56cac99169c76ec94c5787750d7a59cd1fbb68b"
                test "x$sha512" = "x$check"
                chmod +x .ci/sd4/bs/bin/opam.tmp
                mv .ci/sd4/bs/bin/opam.tmp .ci/sd4/bs/bin/opam
            else
                echo "openssl 512 option unsupported."
                exit 61
            fi
          fi
      - name: Bootstrap Opam from GitHub ocaml/opam release (Linux x86)
        if: steps.cache-sd4-bs.outputs.cache-hit != 'true' && matrix.dkml-host-abi == 'linux_x86' && matrix.bootstrap-opam-version == 'os'
        run: |
          #!/bin/sh
          set -eufx
          install -d .ci/sd4/bs/bin
          if [ ! -x .ci/sd4/bs/bin/opam ]; then
            wget -O .ci/sd4/bs/bin/opam.tmp https://github.com/ocaml/opam/releases/download/2.1.2/opam-2.1.2-i686-linux
            sha512_check=$(openssl sha512 2>&1 < /dev/null | cut -f 2 -d ' ')
            if [ "x$SHA512_DEVNULL" = "x$sha512_check" ]; then
                sha512=$(openssl sha512 ".ci/sd4/bs/bin/opam.tmp" 2> /dev/null | cut -f 2 -d ' ')
                check="85a480d60e09a7d37fa0d0434ed97a3187434772ceb4e7e8faa5b06bc18423d004af3ad5849c7d35e72dca155103257fd6b1178872df8291583929eb8f884b6a"
                test "x$sha512" = "x$check"
                chmod +x .ci/sd4/bs/bin/opam.tmp
                mv .ci/sd4/bs/bin/opam.tmp .ci/sd4/bs/bin/opam
            else
                echo "openssl 512 option unsupported."
                exit 61
            fi
          fi

      # Opam prerequisites for using opam (not for installing opam)

      - name: Start environment distribution tarball
        # We use .tar rather than .tar.gz/.tar.bz2 because we can
        # repeatedly add to an uncompressed .tar. But we need to
        # start with an empty tarball since some tar programs will
        # only add (`tar rf xyz.tar`) to an existing .tar.
        run: |
          install -d .ci/sd4/dist
          tar cf .ci/sd4/dist/env-opam.tar -T /dev/null

      # ------
      # BEGIN Docker (ManyLinux)
      #   We use buildx which can cache into GitHub Actions Cache (type=gha)

      - name: Set up Docker Buildx (ManyLinux)
        if: matrix.dockcross_image != ''
        id: buildx
        uses: docker/setup-buildx-action@v2

      - name: Configure Docker (ManyLinux)
        if: matrix.dockcross_image != ''
        run: |
          install -d .ci/sd4/dockcross-ctx
          printf 'FROM %s\nRUN echo done fetching image' '${{ matrix.dockcross_image }}' > .ci/sd4/dockcross-ctx/Dockerfile

      - name: Fetch dockcross image (ManyLinux)
        if: matrix.dockcross_image != ''
        uses: docker/build-push-action@v3
        with:
          context: .ci/sd4/dockcross-ctx
          builder: ${{ steps.buildx.outputs.name }}
          load: true
          tags: dkml-${{ matrix.dockcross_image }}
          cache-from: type=gha,scope=${{ github.workflow }}
          cache-to: type=gha,mode=max,scope=${{ github.workflow }}

      - name: Get dockcross binary (ManyLinux)
        if: matrix.dockcross_image != ''
        run: |
          install -d .ci/sd4
          docker run ${{ matrix.dockcross_run_extra_args }} --rm "dkml-${{ matrix.dockcross_image }}" > .ci/sd4/dockcross
          chmod +x .ci/sd4/dockcross

          # Bundle for consumers of setup-dkml.yml
          tar rvf .ci/sd4/dist/env-opam.tar .ci/sd4/dockcross

      - name: Get Opam prerequisites (ManyLinux)
        if: steps.cache-sd4-bs.outputs.cache-hit != 'true' && matrix.dockcross_image != ''
        run: |
          # rsync needs to be available, even after Docker container disappears
          if [ ! -e .ci/sd4/bs/bin/rsync ]; then
            install -d .ci/sd4/bs/bin
            .ci/sd4/dockcross --args "${{ matrix.dockcross_run_extra_args }}" sh -xc '
              sudo yum install -y rsync &&
              install -v $(command -v rsync) .ci/sd4/bs/bin'
          fi

      # END Docker (ManyLinux)
      # ------

      - name: Get Opam prerequisites (Linux Docker)
        if: steps.cache-sd4-bs.outputs.cache-hit != 'true' && matrix.docker_runner != ''
        run: |
          # rsync needs to be available, even after Docker container disappears
          if [ ! -e .ci/sd4/bs/bin/rsync.deps ]; then
            install -d .ci/sd4/bs/bin
            ${{ matrix.docker_runner }} sh -xc '
              apt-get update &&
              apt-get install -y rsync &&
              ldd /usr/bin/rsync &&
              ls -l /lib/i386-linux-gnu/libpopt.so.0 /lib/i386-linux-gnu/libacl.so.1 /lib/i386-linux-gnu/libattr.so.1 &&
              tar cvCfhz / /work/.ci/sd4/bs/bin/deps.tar.gz /usr/bin/rsync /lib/i386-linux-gnu/libpopt.so.0
            '
            touch .ci/sd4/bs/bin/rsync.deps
          fi

      - name: Bundle Opam prerequisites (ManyLinux or Linux Docker)
        if: matrix.docker_runner != '' || matrix.dockcross_image != ''
        run: |
          # Bundle for consumers of setup-dkml.yml
          tar rvf .ci/sd4/dist/env-opam.tar .ci/sd4/bs/bin/rsync

      # Setup Opam

      - name: Cache Opam root by (host,target)
        uses: actions/cache@v3
        id: cache-sd4-opamroot
        with:
          path: |
            ${{ matrix.opam-root }}/config
            ${{ matrix.opam-root }}/dkml
            ${{ matrix.opam-root }}/repo
            ${{ matrix.opam-root }}/download-cache
            ${{ matrix.opam-root }}/.ci.root-init
            ${{ matrix.opam-root }}/.ci.repo-init
          key:
            c2_${{ inputs.cache-prefix }}_${{ matrix.abi-pattern }}-sd4-opamroot-${{ hashFiles('cachekey.opam.binaries') }}-${{ hashFiles('cachekey.github.inputs') }}

      - name: Write and Distribute Opam scripts
        env:
          # With fdopen's opam.exe, `os-distribution = "cygwinports"`. But native Windows opam.exe has `os-distribution = "win32"`.
          # But on Windows we always want MSYS2 or native Windows libraries, not Cygwin. If cygwinports then
          # code like https://github.com/ocaml/opam-repository/blob/08cbb8258bd4bf30cd6f307c958911a29d537b54/packages/conf-pkg-config/conf-pkg-config.2/opam#L36
          # will fail. So always set `os-distribution = "win32"` on Windows.
          PATCH_OS_DISTRIBUTION_WIN32: ${{ inputs.fdopen-opamexe-bootstrap && startsWith(matrix.dkml-host-abi, 'windows') }}
          # With fdopen's opam.exe, no `exe = ".exe"` is set because Cygwin does not need file extensions. Native Windows
          # requires a .exe extension.
          PATCH_EXE_WIN32: ${{ inputs.fdopen-opamexe-bootstrap && startsWith(matrix.dkml-host-abi, 'windows') }}
        run: |
          #!/bin/sh
          set -euf

          # ---------------------
          # Empty opam repository
          # ---------------------

          install -d .ci/sd4/eor
          cat > .ci/sd4/eor/repo <<EOF
          opam-version: "2.0"
          browse: "https://opam.ocaml.org/pkg/"
          upstream: "https://github.com/ocaml/opam-repository/tree/master/"
          EOF

          # ---------------
          # Create Opam troubleshooting script
          # ---------------

          cat > .ci/sd4/troubleshoot-opam.sh <<EOF
          #!/bin/sh
          set -euf
          OPAMROOT=\$1
          shift
          printf "\n\n========= [START OF TROUBLESHOOTING] ===========\n\n" >&2
          find "\$OPAMROOT"/log -mindepth 1 -maxdepth 1 -name "*.out" ! -name "log-*.out" ! -name "ocaml-variants-*.out" | while read -r dump_on_error_LOG; do
              dump_on_error_BLOG=\$(basename "\$dump_on_error_LOG")
              printf "\n\n========= [TROUBLESHOOTING] %s ===========\n\n" "\$dump_on_error_BLOG" >&2
              awk -v BLOG="\$dump_on_error_BLOG" '{print "[" BLOG "]", \$0}' "\$dump_on_error_LOG" >&2
          done
          printf "\nScroll up to see the [TROUBLESHOOTING] logs that begin at the [START OF TROUBLESHOOTING] line\n" >&2
          EOF

          chmod +x .ci/sd4/troubleshoot-opam.sh
          tar rvf .ci/sd4/dist/env-opam.tar .ci/sd4/troubleshoot-opam.sh

          # ---------------
          # Create Opam support scripts (not needed for all platforms)
          #   The PATH to find opam must work internally in setup-dkml.yml (sd4/bs/bin) and
          #   by consumers of setup-dkml.yml (sd4/opamexe)
          # ---------------

          USER_ID=$(id -u)
          GROUP_ID=$(id -g)
          USER_NAME=$(id -un)
          GROUP_NAME=$(id -gn)

          case "${{ matrix.opam-root }}" in
            /* | ?:*) # /a/b/c or C:\Windows
              ;;
            *) # relative path
              cat > .ci/sd4/env-opam-real <<EOF
          #!/bin/sh
          set -euf
          export PATH="/work/.ci/sd4/bs/bin:/work/.ci/sd4/opamexe:\$PATH"
          export OPAMROOT=/work/${{ matrix.opam-root }}
          if [ "${{ env.PATCH_OS_DISTRIBUTION_WIN32 }}" = true ]; then export OPAMVAR_os_distribution=win32; fi
          if [ "${{ env.PATCH_EXE_WIN32 }}" = true ]; then export OPAMVAR_exe=.exe; fi

          echo "Running inside Docker container: \$*" >&2
          set +e
          "\$@"
          exitcode=\$?
          [ \$exitcode = 0 ] || "/work/.ci/sd4/troubleshoot-opam.sh" \$OPAMROOT
          exit \$exitcode
          EOF
              chmod +x .ci/sd4/env-opam-real
              ;;
          esac

          cat > .ci/sd4/env-opam-deescalate <<EOF
          #!/bin/sh
          set -euf

          if [ -e /work/.ci/sd4/bs/bin/deps.tar.gz ]; then
            tar xCfz / /work/.ci/sd4/bs/bin/deps.tar.gz
          fi

          groupadd -g ${GROUP_ID} ${GROUP_NAME}
          useradd -l -m -u ${USER_ID} -g ${GROUP_ID} ${USER_NAME}
          exec runuser -u ${USER_NAME} -g ${GROUP_NAME} -- "\$@"
          EOF

          chmod +x .ci/sd4/env-opam-deescalate

          # -----------------------------------
          # Create env-opam
          # -----------------------------------

          install -d .ci/sd4/dist

          if [ -x .ci/sd4/dockcross ]; then

            cat > .ci/sd4/env-opam <<EOF
          #!/bin/sh
          set -euf
          exec "$GITHUB_WORKSPACE"/.ci/sd4/dockcross --args "${{ matrix.dockcross_run_extra_args }}" /work/.ci/sd4/env-opam-real "\$@"
          EOF
            chmod +x .ci/sd4/env-opam

            # Bundle for consumers of setup-dkml.yml
            cat .ci/sd4/env-opam-real >&2
            tar rvf .ci/sd4/dist/env-opam.tar .ci/sd4/env-opam .ci/sd4/env-opam-real

          elif [ -n "${{ matrix.docker_runner }}" ]; then

            cat > .ci/sd4/env-opam <<EOF
          #!/bin/sh
          set -euf
          exec ${{ matrix.docker_runner }} /work/.ci/sd4/env-opam-deescalate /work/.ci/sd4/env-opam-real "\$@"
          EOF
            chmod +x .ci/sd4/env-opam

            # Bundle for consumers of setup-dkml.yml
            cat .ci/sd4/env-opam-real >&2
            cat .ci/sd4/env-opam-deescalate >&2
            tar rvf .ci/sd4/dist/env-opam.tar .ci/sd4/env-opam .ci/sd4/env-opam-real .ci/sd4/env-opam-deescalate

          else

            cat > .ci/sd4/env-opam <<EOF
          #!/bin/sh
          set -euf
          export PATH="\$GITHUB_WORKSPACE/.ci/sd4/bs/bin:\$GITHUB_WORKSPACE/.ci/sd4/opamexe:\$PATH"
          export OPAMROOT='${{ matrix.opam-root }}'
          if [ "${{ env.PATCH_OS_DISTRIBUTION_WIN32 }}" = true ]; then export OPAMVAR_os_distribution=win32; fi
          if [ "${{ env.PATCH_EXE_WIN32 }}" = true ]; then export OPAMVAR_exe=.exe; fi

          echo "Running: \$*" >&2
          set +e
          "\$@"
          exitcode=\$?
          [ \$exitcode = 0 ] || "\$GITHUB_WORKSPACE/.ci/sd4/troubleshoot-opam.sh" \$OPAMROOT
          exit \$exitcode
          EOF
            chmod +x .ci/sd4/env-opam

            # Bundle for consumers of setup-dkml.yml
            tar rvf .ci/sd4/dist/env-opam.tar .ci/sd4/env-opam

          fi
          cat .ci/sd4/env-opam >&2

          # -------
          # opamrun
          # -------

          install -d .ci/sd4/opamrun
          cat > .ci/sd4/opamrun/opamrun <<EOF
          #!/bin/sh
          set -euf

          # Add MSVC compiler environment if available
          if [ -e "\$GITHUB_WORKSPACE"/.ci/sd4/msvcenv ]; then
            _oldpath="\$PATH"
            . "\$GITHUB_WORKSPACE"/.ci/sd4/msvcenv
            PATH="\$PATH:\$_oldpath"

            # MSVC (link.exe) needs a TMP as well.
            # Confer: https://docs.microsoft.com/en-us/cpp/build/reference/linking?view=msvc-170#link-environment-variables
            export TMP="\$RUNNER_TEMP"
            if [ -x /usr/bin/cygpath ]; then
              TMP=\$(/usr/bin/cygpath -aw "\$TMP")
            fi
          fi

          # Windows
          if [ -n "${COMSPEC:-}" ]; then
            # We must place MSYS2 in front of path so that MSYS2
            # tar.exe is used instead of Windows tar.exe.
            PATH="/usr/bin:\$PATH"
          fi

          exec "\$GITHUB_WORKSPACE/.ci/sd4/env-opam" opam "\$@"
          EOF
          chmod +x .ci/sd4/opamrun/opamrun

          # Boilerplate to expose opamrun (also used for consumers of setup-dkml.yml)
          opamrunabs="$GITHUB_WORKSPACE/.ci/sd4/opamrun"
          if [ -x /usr/bin/cygpath ]; then opamrunabs=$(/usr/bin/cygpath -aw "$opamrunabs"); fi
          echo "$opamrunabs" >> $GITHUB_PATH
          # Special case: GITHUB_PATH does not influence msys2.CMD of msys2/setup-msys2@v2, so place in real MSYS2 PATH
          if [ -n "${MSYSTEM:-}" ]; then install -d /usr/local/bin; install -v .ci/sd4/opamrun/opamrun /usr/local/bin/opamrun; fi

          # Bundle for consumers of setup-dkml.yml
          tar rvf .ci/sd4/dist/env-opam.tar .ci/sd4/opamrun

      - name: Initialize Opam root
        if: steps.cache-sd4-opamroot.outputs.cache-hit != 'true'
        env:
          ISWINDOWS: ${{ startsWith(matrix.dkml-host-abi, 'windows') }}
        # Complicated Opam sequence is because:
        # 1. Opam's default curl does not work on Windows,
        #    and `opam init` does not provide a way to change it (TODO: need
        #    a PR!).
        # 2. We have to separate the Opam download cache from the other Opam
        #    caches
        run: |
          #!/bin/sh
          set -eufx

          if [ ! -e "$OPAMROOT/.ci.root-init" ]; then
            rm -rf "$OPAMROOT" # Clear any partial previous attempt
            if [ "$ISWINDOWS" = true ]; then
              eor=$(cygpath -am "$GITHUB_WORKSPACE"/.ci/sd4/eor)
              opamrun init --disable-sandboxing --no-setup --kind local --bare "$eor"
              case "$(opamrun --version)" in
                2.0.*) echo 'download-command: wget' >> $OPAMROOT/config ;;
                *)     opamrun option --yes --global download-command=wget
              esac
            elif [ "${{ matrix.in_docker }}" = "true" ]; then
              opamrun init --disable-sandboxing --no-setup --kind local --bare "/work/.ci/sd4/eor"
            else
              opamrun init --disable-sandboxing --no-setup --kind local --bare "$GITHUB_WORKSPACE/.ci/sd4/eor"
            fi
            touch "$OPAMROOT/.ci.root-init"
          fi
          opamrun var --global || true

      # Build OCaml

      - name: Setup Opam repositories
        if: steps.cache-sd4-opamroot.outputs.cache-hit != 'true'
        # `opam repository` operations need the Opam switches present to perform
        # updates, so this step comes after the Opam switch cache load but before the
        # initial Opam switch creation.
        run: |
          #!/bin/sh
          set -eufx
          if [ -x /usr/bin/cygpath ]; then
            export TEMP=$(cygpath -am "$RUNNER_TEMP")
          fi
          if [ ! -e "$OPAMROOT/.ci.repo-init" ]; then
            opamrun repository remove default --yes --all --dont-select || true
            opamrun repository remove diskuv --yes --all --dont-select || true
            opamrun repository add default https://opam.ocaml.org --yes --dont-select
            opamrun repository add diskuv "git+https://github.com/diskuv/diskuv-opam-repository.git#${DISKUV_OPAM_REPOSITORY:-$DEFAULT_DISKUV_OPAM_REPOSITORY_TAG}" --yes --dont-select
            touch "$OPAMROOT/.ci.repo-init"
          fi

          # Whether .ci.repo-init or not, always set the `diskuv` repository url since it can change
          opamrun repository set-url diskuv "git+https://github.com/diskuv/diskuv-opam-repository.git#${DISKUV_OPAM_REPOSITORY:-$DEFAULT_DISKUV_OPAM_REPOSITORY_TAG}" --yes --dont-select
          # Update both `default` and `diskuv` Opam repositories
          opamrun update default diskuv

      # Create, or recreate, the Opam switch. The Opam switch should not be
      # cached except for the compiler (confer docs for setup-ocaml GitHub
      # Action) which is the 'dkml' switch
      - name: Create Opam switch
        if: steps.cache-sd4-opamroot.outputs.cache-hit != 'true'
        run: |
          #!/bin/sh
          set -eufx

          # Check if the switch name is present in the Opam root (which may come from cache)
          NOMINALLY_PRESENT=false
          if opamrun switch list --short | grep '^dkml$'; then NOMINALLY_PRESENT=true; fi

          # Check if the switch is actually present in case of cache incoherence
          # or corrupt Opam state that could result in:
          #   Error:  No config file found for switch dkml. Switch broken?
          if [ $NOMINALLY_PRESENT = true ] && [ ! -e $OPAMROOT/dkml/.opam-switch/switch-config ]; then
            # Remove the switch name from Opam root, and any partial switch state.
            # Ignore inevitable warnings/failure about missing switch.
            opamrun switch remove dkml --yes || true
            rm -rf $OPAMROOT/dkml
            NOMINALLY_PRESENT=false
          fi

          if [ $NOMINALLY_PRESENT = false ]; then
            opamrun switch create dkml --repos diskuv,default --empty --yes
          fi

      # The action/checkout steps used for pinning will re-use existing Git objects
      # because of caching
      - name: Cache Git checkouts of Opam pins by OS
        uses: actions/cache@v3
        id: cache-sd4-git
        with:
          path: .ci/sd4/g
          key:
            ${{ inputs.cache-prefix }}_${{ runner.os }}-sd4-git-${{ hashFiles('cachekey.github.inputs') }}

      # dkml-base-compiler

      # Until https://github.com/ocaml/opam-repository/pull/21704 resolved we can't go past the
      # commit to remove 32-bit option. After resolved, collapse `env.DKML_BASE_COMPILER ==,!= ''`
      # into one
      - name: Checkout dkml-base-compiler (dkml-base-compiler specified but empty; no ocaml-compiler specified)
        if: steps.cache-sd4-git.outputs.cache-hit != 'true' && env.DKML_BASE_COMPILER != '@repository@' && env.DKML_BASE_COMPILER == '' && inputs.ocaml-compiler == ''
        uses: actions/checkout@v3
        with:
          repository: diskuv/dkml-compiler
          path: .ci/sd4/g/dkml-base-compiler
          ref: 4.12.1-v0.4.1-prerel6

      - name: Checkout dkml-base-compiler (dkml-base-compiler specified non-empty; no ocaml-compiler specified)
        if: steps.cache-sd4-git.outputs.cache-hit != 'true' && env.DKML_BASE_COMPILER != '@repository@' && env.DKML_BASE_COMPILER != '' && inputs.ocaml-compiler == ''
        uses: actions/checkout@v3
        with:
          repository: diskuv/dkml-compiler
          path: .ci/sd4/g/dkml-base-compiler
          ref: ${{ env.DKML_BASE_COMPILER }} # empty is no `ref`, which is default branch

      - name: Validate ocaml-compiler (ocaml-compiler specified)
        if: inputs.ocaml-compiler != ''
        run: |
          case "${{ inputs.ocaml-compiler }}" in
            4.12.1) true ;;
            *)
              echo "ocaml-compiler version ${{ inputs.ocaml-compiler }} is not supported" >&2
              exit 109
              ;;
          esac

      - name: Checkout dkml-base-compiler (ocaml-compiler specified)
        if: steps.cache-sd4-git.outputs.cache-hit != 'true' && inputs.ocaml-compiler != ''
        uses: actions/checkout@v3
        with:
          repository: diskuv/dkml-compiler
          path: .ci/sd4/g/dkml-base-compiler
          ref: ${{ inputs.ocaml-compiler }}-v${{ env.DKML_VERSION }}

      - name: Pin dkml-base-compiler to checkout instead of Opam repository (ocaml-compiler or dkml-base-compiler specified)
        if: "!(steps.cache-sd4-opamroot.outputs.cache-hit == 'true' && steps.cache-sd4-git.outputs.cache-hit == 'true') && (env.DKML_BASE_COMPILER != '@repository@' || inputs.ocaml-compiler != '')"
        run: opamrun pin add --yes --no-action dkml-base-compiler .ci/sd4/g/dkml-base-compiler

      # conf-dkml-cross-toolchain

      - name: Checkout conf-dkml-cross-toolchain
        if: steps.cache-sd4-git.outputs.cache-hit != 'true' && env.CONF_DKML_CROSS_TOOLCHAIN != '@repository@'
        uses: actions/checkout@v3
        with:
          repository: diskuv/conf-dkml-cross-toolchain
          path: .ci/sd4/g/conf-dkml-cross-toolchain
          ref: ${{ env.CONF_DKML_CROSS_TOOLCHAIN }} # empty is no `ref`, which is default branch

      - name: Pin conf-dkml-cross-toolchain to checkout instead of Opam repository
        if: "!(steps.cache-sd4-opamroot.outputs.cache-hit == 'true' && steps.cache-sd4-git.outputs.cache-hit == 'true') && env.CONF_DKML_CROSS_TOOLCHAIN != '@repository@'"
        run: opamrun pin add --yes --no-action conf-dkml-cross-toolchain .ci/sd4/g/conf-dkml-cross-toolchain

      # patches necessary for Windows in diskuv-opam-repository
      #
      # - ocamlfind and ocamlbuild
      #
      # - dune-configurator (and hence Dune)
      # Dune 2.9.1 and 3.0.2 will fail to build jst-config.v0.14.1 because for jst-config/discover/discover.ml Dune does:
      #   cl -nologo -O2 -Gy- -MD    -I Z:/.opam-root-cached-8/installer-ocaml/lib/ocaml -o C:\Users\beckf\AppData\Local\Temp\build_f18aec_dune\ocaml-configurator4d3858\c-test-31\test.obj -c C:\Users\beckf\AppData\Local\Temp\build_f18aec_dune\ocaml-configurator4d3858\c-test-31\test.c advapi32.lib ws2_32.lib version.lib
      # instead of
      #   cl -nologo -O2 -Gy- -MD    -I Z:/.opam-root-cached-8/installer-ocaml/lib/ocaml /FoC:\Users\beckf\AppData\Local\Temp\build_f18aec_dune\ocaml-configurator4d3858\c-test-31\test.obj -c C:\Users\beckf\AppData\Local\Temp\build_f18aec_dune\ocaml-configurator4d3858\c-test-31\test.c advapi32.lib ws2_32.lib version.lib
      # with the (irrelevant) test.c file:
      #    #include <stdio.h>
      #    #include <caml/config.h>
      #
      #    #ifdef ARCH_BIG_ENDIAN
      #    const char *s0 = "BEGIN-0-true-END";
      #    #else
      #    const char *s0 = "BEGIN-0-false-END";
      #    #endif
      #
      #    #ifdef ARCH_SIXTYFOUR
      #    const char *s1 = "BEGIN-1-true-END";
      #    #else
      #    const char *s1 = "BEGIN-1-false-END";
      #    #endif
      #
      # The actual problem is dune-configurator ... we only have patches in Diskuv
      # repository up until 2.9.3. Need to upstream fix the problem.
      #
      # - ppx_expect; only patch is for v0.14.1. Need to upstream fix the problem.
      # - base; patches for v0.14.1/2/3. Need to upstream fix the problem.
      - name: Pins for packages in diskuv-opam-repository
        if: steps.cache-sd4-opamroot.outputs.cache-hit != 'true'
        run: |
          opamrun pin add --yes --no-action -k version base ${{ env.PIN_BASE }}
          opamrun pin add --yes --no-action -k version bigstringaf ${{ env.PIN_BIGSTRINGAF }}
          opamrun pin add --yes --no-action -k version core_kernel ${{ env.PIN_CORE_KERNEL }}
          opamrun pin add --yes --no-action -k version ctypes ${{ env.PIN_CTYPES }}
          opamrun pin add --yes --no-action -k version ctypes-foreign ${{ env.PIN_CTYPES_FOREIGN }}
          opamrun pin add --yes --no-action -k version curly ${{ env.PIN_CURLY }}
          opamrun pin add --yes --no-action -k version digestif ${{ env.PIN_DIGESTIF }}
          opamrun pin add --yes --no-action -k version dune ${{ env.PIN_DUNE }}
          opamrun pin add --yes --no-action -k version dune-configurator ${{ env.PIN_DUNE }}
          opamrun pin add --yes --no-action -k version ocamlbuild ${{ env.PIN_OCAMLBUILD }}
          opamrun pin add --yes --no-action -k version ocamlfind ${{ env.PIN_OCAMLFIND }}
          opamrun pin add --yes --no-action -k version ocp-indent ${{ env.PIN_OCP_INDENT }}
          opamrun pin add --yes --no-action -k version ppx_expect ${{ env.PIN_PPX_EXPECT }}
          opamrun pin add --yes --no-action -k version ptime ${{ env.PIN_PTIME }}
          opamrun pin add --yes --no-action -k version time_now ${{ env.PIN_TIME_NOW }}

      # Setup C compiler

      - name: Cache Visual Studio environment variables by (host,target)
        uses: actions/cache@v3
        if: startsWith(matrix.dkml-host-abi, 'windows')
        id: cache-sd4-vsenv
        with:
          path: .ci/sd4/vsenv
          key: ${{ inputs.cache-prefix }}_${{ matrix.abi-pattern }}-sd4-vsenv-${{ hashFiles('cachekey.vsstudio') }}

      - name: Checkout dkml-runtime-distribution (Windows)
        if: steps.cache-sd4-git.outputs.cache-hit != 'true' && startsWith(matrix.dkml-host-abi, 'windows')
        uses: actions/checkout@v3
        with:
          repository: diskuv/dkml-runtime-distribution
          path: .ci/sd4/g/dkml-runtime-distribution
          ref: 1a3ec82dd851751a95e6a4797387a8163c51520e

      - name: Diagnose Visual Studio environment variables (Windows)
        # This wastes time and has lots of rows! Only run if "verbose" GitHub input key.
        if: inputs.verbose && startsWith(matrix.dkml-host-abi, 'windows')
        shell: pwsh
        run: |
          if (Test-Path -Path "C:\Program Files (x86)\Windows Kits\10\include") {
            dir "C:\Program Files (x86)\Windows Kits\10\include"
          }
          if (Test-Path -Path "C:\Program Files (x86)\Windows Kits\10\Extension SDKs\WindowsDesktop") {
            dir "C:\Program Files (x86)\Windows Kits\10\Extension SDKs\WindowsDesktop"
          }

          $env:PSModulePath += "$([System.IO.Path]::PathSeparator).ci\sd4\g\dkml-runtime-distribution\src\windows"
          Import-Module Machine

          $allinstances = Get-VSSetupInstance
          $allinstances | ConvertTo-Json -Depth 5

      - name: Locate Visual Studio (Windows)
        if: startsWith(matrix.dkml-host-abi, 'windows') && steps.cache-sd4-vsenv.outputs.cache-hit != 'true' && matrix.vsstudio-dir == ''
        shell: pwsh
        run: |
          if (!(Test-Path -Path ${env:GITHUB_WORKSPACE}/.ci/sd4/vsenv)) {
            $env:PSModulePath += "$([System.IO.Path]::PathSeparator).ci\sd4\g\dkml-runtime-distribution\src\windows"
            Import-Module Machine

            $CompatibleVisualStudios = Get-CompatibleVisualStudios -ErrorIfNotFound
            $CompatibleVisualStudios
            $ChosenVisualStudio = ($CompatibleVisualStudios | Select-Object -First 1)
            $VisualStudioProps = Get-VisualStudioProperties -VisualStudioInstallation $ChosenVisualStudio
            $VisualStudioProps

            echo "VS_DIR=$($VisualStudioProps.InstallPath)" > ${env:GITHUB_WORKSPACE}/.ci/sd4/vsenv
            echo "VS_VCVARSVER=$($VisualStudioProps.VcVarsVer)" >> ${env:GITHUB_WORKSPACE}/.ci/sd4/vsenv
            echo "VS_WINSDKVER=$($VisualStudioProps.WinSdkVer)" >> ${env:GITHUB_WORKSPACE}/.ci/sd4/vsenv
            echo "VS_MSVSPREFERENCE=$($VisualStudioProps.MsvsPreference)" >> ${env:GITHUB_WORKSPACE}/.ci/sd4/vsenv
            echo "VS_CMAKEGENERATOR=$($VisualStudioProps.CMakeGenerator)" >> ${env:GITHUB_WORKSPACE}/.ci/sd4/vsenv
          }

      - name: Link to hardcoded Visual Studio (Windows)
        if: startsWith(matrix.dkml-host-abi, 'windows') && steps.cache-sd4-vsenv.outputs.cache-hit != 'true' && matrix.vsstudio-dir != ''
        shell: pwsh
        run: |
          echo "VS_DIR=${{ matrix.vsstudio-dir }}" > ${env:GITHUB_WORKSPACE}/.ci/sd4/vsenv
          echo "VS_VCVARSVER=${{ matrix.vsstudio-vcvarsver }}" >> ${env:GITHUB_WORKSPACE}/.ci/sd4/vsenv
          echo "VS_WINSDKVER=${{ matrix.vsstudio-winsdkver }}" >> ${env:GITHUB_WORKSPACE}/.ci/sd4/vsenv
          echo "VS_MSVSPREFERENCE=${{ matrix.vsstudio-msvspreference }}" >> ${env:GITHUB_WORKSPACE}/.ci/sd4/vsenv
          echo "VS_CMAKEGENERATOR=${{ matrix.vsstudio-cmakegenerator }}" >> ${env:GITHUB_WORKSPACE}/.ci/sd4/vsenv

      - name: Export Visual Studio location and type (Windows)
        if: startsWith(matrix.dkml-host-abi, 'windows')
        shell: pwsh
        run: |
          Get-Content ${env:GITHUB_WORKSPACE}/.ci/sd4/vsenv
          Get-Content ${env:GITHUB_WORKSPACE}/.ci/sd4/vsenv >> $env:GITHUB_ENV

      - name: Create Visual Studio support scripts (Windows)
        if: startsWith(matrix.dkml-host-abi, 'windows')
        shell: pwsh
        run: |
          # MSVC environment variables:
          # 1. https://docs.microsoft.com/en-us/cpp/build/reference/cl-environment-variables?view=msvc-170
          # 2. https://docs.microsoft.com/en-us/cpp/build/reference/linking?view=msvc-170#link-environment-variables (except TMP)
          # 3. VCToolsRedistDir: https://docs.microsoft.com/en-us/cpp/windows/redistributing-visual-cpp-files?view=msvc-170#locate-the-redistributable-files
          $awk = @"
          BEGIN{FS="="}
          `$1=="CL"||`$1=="_CL_"||`$1=="INCLUDE"||`$1=="LIBPATH" {print "export " `$0}
          `$1=="LINK"||`$1=="_LINK_"||`$1=="LIB"||`$1=="PATH"    {print "export " `$0}
          `$1=="VCToolsRedistDir"                                {print "export " `$0}
          "@
          [IO.File]::WriteAllLines(".ci/sd4/msvcenv.awk", $awk)

          $awk = @"
          {print "export PATH='" `$0 "'"}
          "@
          [IO.File]::WriteAllLines(".ci/sd4/msvcpath.awk", $awk)

      - name: Capture Visual Studio compiler environment (1/2) (Windows)
        if: startsWith(matrix.dkml-host-abi, 'windows')
        shell: cmd
        run: |
          @echo OFF

          REM The OCaml dkml-base-compiler will compile fine but any other
          REM packages (ocamlbuild, etc.) which
          REM need a native compiler will fail without the MSVC compiler in the
          REM PATH. There isn't a `with-dkml.exe` alternative available at
          REM this stage of the GitHub workflow.
          call "%VS_DIR%\Common7\Tools\VsDevCmd.bat" -no_logo -host_arch=${{ matrix.vsstudio-hostarch }} -arch=${{ matrix.vsstudio-arch }} -vcvars_ver=%VS_VCVARSVER% -winsdk=%VS_WINSDKVER%
          if %ERRORLEVEL% neq 0 (
            echo.
            echo.The "%VS_DIR%\Common7\Tools\VsDevCmd.bat" command failed
            echo.with exit code %ERRORLEVEL%.
            echo.
            exit /b %ERRORLEVEL%
          )

          REM VsDevCmd.bat turns off echo; be explicit if we want it on or off
          @echo OFF

          REM MSVC environment variables in Unix format.
          REM * We can't use `msys2 -c` directly to query for all MSVC environment variables
          REM   because it stomps over the PATH. So we have a separate solution for PATH.
          echo %PATH% > .ci\sd4\msvcpath
          msys2 -c "set | grep -v '^PATH=' | awk -f .ci/sd4/msvcenv.awk > .ci/sd4/msvcenv"

          REM (For some reason no shell commands can happen after the last msys2 -c, so split into 2 GitHub Actions steps!)

      - name: Capture Visual Studio compiler environment (2/2) (Windows)
        if: startsWith(matrix.dkml-host-abi, 'windows')
        run: |
          #!/bin/sh
          set -euf
          cat .ci/sd4/msvcpath | tr -d '\r' | cygpath --path -f - | awk -f .ci/sd4/msvcpath.awk >> .ci/sd4/msvcenv

          tail -n100 .ci/sd4/msvcpath .ci/sd4/msvcenv >&2

      - name: Use Visual Studio in dkml-* Opam packages (Windows)
        if: "!(steps.cache-sd4-vsenv.outputs.cache-hit == 'true' && steps.cache-sd4-opamroot.outputs.cache-hit == 'true') && startsWith(matrix.dkml-host-abi, 'windows')"
        run: |

          # Make the standard input work as an OCaml string.
          # This currently only escapes backslashes and double quotes.
          escape_arg_as_ocaml_string() {
              escape_arg_as_ocaml_string_ARG=$1
              shift
              printf "%s" "$escape_arg_as_ocaml_string_ARG" | sed 's#\\#\\\\#g; s#"#\\"#g;'
          }
          E_VS_DIR=$(escape_arg_as_ocaml_string "$VS_DIR")
          E_VS_VCVARSVER=$(escape_arg_as_ocaml_string "$VS_VCVARSVER")
          E_VS_WINSDKVER=$(escape_arg_as_ocaml_string "$VS_WINSDKVER")
          E_VS_MSVSPREFERENCE=$(escape_arg_as_ocaml_string "$VS_MSVSPREFERENCE")
          E_VS_CMAKEGENERATOR=$(escape_arg_as_ocaml_string "$VS_CMAKEGENERATOR")

          case "$(opamrun --version)" in
            2.0.*)
              if [ "${{ matrix.in_docker }}" = "true" ]; then
                echo Opam 2.0 support in dockcross to use a portable opam var prefix not yet implemented
                exit 67
              fi
              OP=$(opamrun var prefix)
              OPSC=$OP/.opam-switch/switch-config
              if grep setenv: $OPSC; then
                echo "INFO: Updating switch-config. Old was:"
                awk '{print ">> " $0}' $OPSC

                awk '$1=="setenv:"{x=1} x==0{print} x==1 && $0=="]"{x=0}' $OPSC > $OPSC.trimmed
                mv $OPSC.trimmed $OPSC
              fi
              echo 'setenv: [' >> $OPSC
              echo '  [DKML_COMPILE_SPEC = "1"]' >> $OPSC
              echo '  [DKML_COMPILE_TYPE = "VS"]' >> $OPSC
              echo "  [DKML_COMPILE_VS_DIR = \"$E_VS_DIR\"]" >> $OPSC
              echo "  [DKML_COMPILE_VS_VCVARSVER = \"$E_VS_VCVARSVER\"]" >> $OPSC
              echo "  [DKML_COMPILE_VS_WINSDKVER = \"$E_VS_WINSDKVER\"]" >> $OPSC
              echo "  [DKML_COMPILE_VS_MSVSPREFERENCE = \"$E_VS_MSVSPREFERENCE\"]" >> $OPSC
              echo "  [DKML_COMPILE_VS_CMAKEGENERATOR = \"$E_VS_CMAKEGENERATOR\"]" >> $OPSC
              echo "  [DKML_HOST_ABI = \"${{ matrix.dkml-host-abi }}\"]" >> $OPSC
              echo ']' >> $OPSC
              cat $OPSC >&2 # print
              ;;
            *)
              opamrun option setenv= # reset
              opamrun option setenv+='DKML_COMPILE_SPEC = "1"'
              opamrun option setenv+='DKML_COMPILE_TYPE = "VS"'
              opamrun option setenv+="DKML_COMPILE_VS_DIR = \"$E_VS_DIR\""
              opamrun option setenv+="DKML_COMPILE_VS_VCVARSVER = \"$E_VS_VCVARSVER\""
              opamrun option setenv+="DKML_COMPILE_VS_WINSDKVER = \"$E_VS_WINSDKVER\""
              opamrun option setenv+="DKML_COMPILE_VS_MSVSPREFERENCE = \"$E_VS_MSVSPREFERENCE\""
              opamrun option setenv+="DKML_COMPILE_VS_CMAKEGENERATOR = \"$E_VS_CMAKEGENERATOR\""
              opamrun option setenv+="DKML_HOST_ABI = \"${{ matrix.dkml-host-abi }}\""
              opamrun option setenv # print
              ;;
          esac

          opamrun exec -- sh -c 'echo $VCToolsRedistDir'

      - name: Install OCaml compiler
        if: "!(steps.cache-sd4-bs.outputs.cache-hit == 'true' && steps.cache-sd4-git.outputs.cache-hit == 'true' && steps.cache-sd4-opamroot.outputs.cache-hit == 'true' && (!startsWith(matrix.dkml-host-abi, 'windows') || steps.cache-sd4-vsenv.outputs.cache-hit == 'true'))"
        run: |
          #!/bin/sh
          set -eufx
          opamrun pin list
          opamrun upgrade --yes dkml-base-compiler conf-dkml-cross-toolchain ${{ matrix.ocaml-options }}

      # Bundle

      #   During cache read (the "Cache Opam root by (host,target)" step) we get:
      #      Cache Size: ~212 MB (222698916 B)
      #      C:\Windows\System32\tar.exe -z -xf D:/a/_temp/9b656ed6-e727-4499-b4f8-b34d5979d42b/cache.tgz -P -C D:/a/dkml-workflows-regular-example/dkml-workflows-regular-example
      #      ../../.opam/download-cache/md5/65/65e6dc9b305ccbed1267275fe180f538: Can't create '\\\\?\\D:\\a\\dkml-workflows-regular-example\\dkml-workflows-regular-example\\..\\..\\.opam\\download-cache\\md5\\65\\65e6dc9b305ccbed1267275fe180f538'
      #      ../../.opam/download-cache/md5/63/63b2ecad76cf56102074f3203fc8c0be: Can't create '\\\\?\\D:\\a\\dkml-workflows-regular-example\\dkml-workflows-regular-example\\..\\..\\.opam\\download-cache\\md5\\63\\63b2ecad76cf56102074f3203fc8c0be'
      #      tar.exe: Error exit delayed from previous errors.
      #      Warning: Failed to restore: Tar failed with error: The process 'C:\Windows\System32\tar.exe' failed with exit code 1
      #      Cache not found for input keys: v1_win32-windows_x86-sd4-opamroot-f674af417c46862703911bc9aee57c19d6c436776c657533610dc233fae8e8af-5850674459249f5d9ea150785baa5177201737ce2c7d59834aa7457c06c929e7
      #   So get rid of Opam's md5 download cache.
      - name: Remove problematic files from Opam download cache
        if: startsWith(matrix.dkml-host-abi, 'windows')
        run: |
          set -x
          rm -rf '${{ matrix.opam-root }}/download-cache/md5'

      - name: Distribute source code, Opam environment, and Opam root
        run: |
          #!/bin/sh
          set -eufx

          create_tar() {
            create_tar_DIR=$1
            shift
            create_tar_FILE=$1
            shift
            case "${{ matrix.dkml-host-abi }}" in
              linux_*|windows_*)
                # GNU tar (Windows uses MSYS2 GNU tar) has the [-H format] option
                # where the [posix] format will store fractional second precision, which
                # is needed by Opam to see if any files have been modified.
                # Confer: https://unix.stackexchange.com/questions/397130/tar-how-to-preserve-timestamps-down-to-more-than-a-second-of-precision
                # and: https://www.freebsd.org/cgi/man.cgi?tar(5)
                tar cCfHz "$create_tar_DIR" "$create_tar_FILE" posix "$@"
                ;;
              *)
                tar cCfz "$create_tar_DIR" "$create_tar_FILE" "$@"
            esac
          }

          create_tar $OPAMROOT .ci/sd4/dist/opamroot.tar.gz --exclude ./dkml/.opam-switch/build --exclude ./log .

          create_tar .ci/sd4/g .ci/sd4/dist/sources.tar.gz .

          # Capture whichever opam.exe we have been using
          install -d .ci/sd4/opamexe
          printf "#!/bin/sh\ninstall -v %s .ci/sd4/opamexe/opam%s\n" '$(command -v opam)' "${EXE_EXT}" > .ci/sd4/export-opam.sh
          cat .ci/sd4/export-opam.sh >&2
          chmod +x .ci/sd4/export-opam.sh
          .ci/sd4/env-opam .ci/sd4/export-opam.sh

          # Update the tar ball with the opam executable, and possibly DLLs (especially from fdopen)
          if [ -e .ci/sd4/bs/bin ]; then
            find .ci/sd4/bs/bin -mindepth 1 -maxdepth 1 -name "Opam.Runtime.*" | while read -r runtime; do
              cp -rp $runtime .ci/sd4/opamexe/
            done
          fi
          tar rvf .ci/sd4/dist/env-opam.tar .ci/sd4/opamexe/

          # Update tar ball with MSVC environment
          if [ -e .ci/sd4/msvcenv ]; then
            tar rvf .ci/sd4/dist/env-opam.tar .ci/sd4/msvcenv
          fi

      # Upload

      - name: Upload
        uses: actions/upload-artifact@v3
        with:
          name: setup-dkml-${{ matrix.abi-pattern }}
          path: |
            .ci/sd4/dist/opamroot.tar.gz
            .ci/sd4/dist/sources.tar.gz
            .ci/sd4/dist/env-opam.tar
